<!DOCTYPE html>
<html lang="ko">

<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <link rel="icon" type="image/png" href="favicon.png?v=2">
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <link rel="apple-touch-icon" href="favicon.png?v=2">
  <link rel="shortcut icon" href="favicon.ico?v=2">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üêÑMemoooooüêÑ</title>
  <style>
    #loginView {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 30px;
      background-color: #ccc;
      z-index: 999;
      position: relative;
    }

    /* ===============================
      Global Reset & iOS Fix
    ================================ */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: #f5f5f7;
      color: #111;
    }

    /* ÏûÖÎ†• Ïãú ÌôïÎåÄ Î∞©ÏßÄ (iOS ÌïµÏã¨) */
    input,
    textarea,
    [contenteditable] {
      font-size: 16px !important;
      touch-action: manipulation;
    }

    /* ===============================
      Navigation Bar
    ================================ */
    #navbar {
      position: sticky;
      top: 0;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;

      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(0, 0, 0, .06);
      z-index: 9999;
    }

    #navTitle {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    #installBtn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 14px;
      background: #317efb;
      color: #fff;
    }

    /* ===============================
      Masonry Layout
    ================================ */
    #listView {
      padding: 20px;
      column-gap: 12px;
      column-count: 5;
    }

    @media (max-width: 1200px) {
      #listView {
        column-count: 4;
      }
    }

    @media (max-width: 900px) {
      #listView {
        column-count: 3;
      }
    }

    /* Î™®Î∞îÏùº: Î¨¥Ï°∞Í±¥ 2Ïó¥ */
    @media (max-width: 600px) {
      #listView {
        column-count: 2;
        padding: 14px;
        column-gap: 10px;
      }
    }

    /* ===============================
      Memo Card (Apple Style)
    ================================ */
    .memo-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 14px;
      break-inside: avoid;
      cursor: pointer;

      box-shadow:
        0 1px 2px rgba(0, 0, 0, .04),
        0 8px 24px rgba(0, 0, 0, .06);

      transition:
        transform .25s cubic-bezier(.2, .8, .2, 1),
        box-shadow .25s cubic-bezier(.2, .8, .2, 1);
    }

    /* Hover (Desktop) */
    @media (hover: hover) {
      .memo-card:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow:
          0 6px 16px rgba(0, 0, 0, .08),
          0 20px 40px rgba(0, 0, 0, .12);
      }
    }

    /* Click / Tap ÌôïÎåÄ Ìä∏ÎûúÏßÄÏÖò */
    .memo-card:active {
      transform: scale(0.97);
    }

    /* ===============================
      Card Typography
    ================================ */
    .memo-subject {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #111;
      margin-bottom: 8px;
    }

    .memo-text {
      font-size: 14px;
      line-height: 1.55;
      color: #555;
      letter-spacing: -0.01em;

      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* ===============================
      Floating Add Button
    ================================ */
    #addBtn {
      position: fixed;
      right: 22px;
      bottom: 22px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;

      background: rgba(49, 126, 251, .9);
      color: #fff;
      font-size: 22px;

      box-shadow: 0 10px 24px rgba(49, 126, 251, .35);
      transition: transform .2s ease;
    }

    #addBtn:hover {
      transform: scale(1.08) rotate(45deg);
    }

    /* ===============================
      Editor View
    ================================ */
    #editorView {
      display: none;
      position: fixed;
      inset: 0;
      margin: auto;

      width: min(92vw, 720px);
      max-height: calc(100vh - 32px - env(safe-area-inset-bottom));

      background: #ffffff;
      border-radius: 22px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);

      padding: 16px;
      z-index: 9999;

      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (min-width: 601px) {
      #editorView {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    }

    @media (max-width: 600px) {
      #editorView {
        width: 100vw;
        height: calc(100vh - env(safe-area-inset-bottom));
        max-height: none;

        border-radius: 0;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }

    #editorSubject {
      width: 100%;
      font-size: 20px;
      font-weight: 600;
      border: none;
      outline: none;
      border-bottom: 1px solid #eaeaea;
      background-color: #ffffff;
      padding: 10px 6px;
      margin-bottom: 12px;
    }

    #editorText {
      flex: 1;
      width: 100%;
      border: none;
      outline: none;

      font-size: 16px;
      line-height: 1.6;
      padding: 8px 6px;

      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #editorText img,
    .memo-text img {
      max-width: 100%;
      border-radius: 12px;
    }

    /* ===============================
      Buttons (iOS Style)
    ================================ */
    #editorButtons {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .editor-btn,
    #deleteMemoBtn {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #f8f8f8;
      cursor: pointer;
    }

    #deleteMemoBtn {
      background: rgba(255, 59, 48, .12);
      color: #ff3b30;
    }

    #closeEditor {
      position: fixed;
      z-index: 10;
      bottom: 20px;
      right: 20px;

      align-self: flex-end;
      background: none;
      border: none;
      font-size: 14px;
      color: #111;
      padding: 4px 8px;
      cursor: pointer;
    }

    /* ===============================
      Saving Overlay
    ================================ */
    #savingOverlay {
      display: none;
      background: rgba(0, 0, 0, .4);
      backdrop-filter: blur(6px);
    }

    /* ===============================
      iOS Install Guide Overlay
    ================================ */
    #iosInstallGuide {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100000;

      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(10px);
    }

    #iosInstallGuide .ios-box {
      width: min(320px, 90%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 18px;
      padding: 20px 18px;
      text-align: center;

      box-shadow:
        0 10px 30px rgba(0, 0, 0, 0.25);

      animation: iosGuidePop .28s cubic-bezier(.2,.8,.2,1);
    }

    #iosInstallGuide strong {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
    }

    #iosInstallGuide p {
      font-size: 14px;
      line-height: 1.5;
      margin: 0 0 14px;
    }

    #iosInstallGuide button {
      border: none;
      border-radius: 10px;
      padding: 6px 14px;
      font-size: 14px;
      background: rgba(0, 0, 0, .08);
    }

    /* Pop Animation */
    @keyframes iosGuidePop {
      from {
        transform: scale(0.96);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }


    /* ===============================
      Dark Mode (Auto)
    ================================ */
    @media (prefers-color-scheme: dark) {
      body {
        background: #0f0f10;
        color: #f5f5f7;
      }

      #navbar {
        background: rgba(28, 28, 30, .75);
        border-bottom: 1px solid rgba(255, 255, 255, .08);
      }

      .memo-card {
        background: rgba(28, 28, 30, .9);
        box-shadow:
          0 1px 2px rgba(0, 0, 0, .6),
          0 12px 28px rgba(0, 0, 0, .8);
      }

      .memo-subject {
        color: #f5f5f7;
      }

      .memo-text {
        color: #b0b0b5;
      }

      #editorView {
        background: #1c1c1e;
      }

      #editorSubject,
      #editorText {
        color: #f5f5f7;
        background-color: #2c2c2e;
        border-color: rgba(255, 255, 255, .1);
      }

      .editor-btn,
      #closeEditor {
        background: rgba(255, 255, 255, .08);
        color: #f5f5f7;
      }

      #deleteMemoBtn {
        background: rgba(255, 59, 48, .2);
        color: #ff453a;
      }

      #iosInstallGuide .ios-box {
        background: rgba(28, 28, 30, 0.95);
        color: #f5f5f7;
      }

      #iosInstallGuide button {
        background: rgba(255, 255, 255, .12);
        color: #f5f5f7;
      }
    }

    /* ===============================
      Navbar Scroll Enhancement
    ================================ */
    #navbar {
      transition:
        backdrop-filter .25s ease,
        background-color .25s ease,
        box-shadow .25s ease;
    }

    /* Ïä§ÌÅ¨Î°§ Ïãú */
    #navbar.scrolled {
      backdrop-filter: blur(22px);
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }

    /* Îã§ÌÅ¨Î™®Îìú */
    @media (prefers-color-scheme: dark) {
      #navbar.scrolled {
        background: rgba(28, 28, 30, 0.88);
        box-shadow: 0 6px 24px rgba(0,0,0,.6);
      }
    }
  </style>
</head>

<body>
  <div id="navbar">
    <div id="navTitle">üêÑ Memooooooooooooooo</div>
    <button id="installBtn">ÏÑ§Ïπò</button>
  </div>

  <!-- Login -->
  <div id="loginView">
    <div id="g_id_onload" data-client_id="765077747854-o62lf714ob2ncr2sq0l68ies31hp6p43.apps.googleusercontent.com"
      data-callback="handleLogin" data-auto_prompt="false">
    </div>
    <div class="g_id_signin"></div>
  </div>

  <!-- iOS Install Guide -->
  <div id="iosInstallGuide">
    <div class="ios-box">
      <strong>üì≤ Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÌïòÍ∏∞</strong>
      <p>
        Safari ÌïòÎã®Ïùò <b>Í≥µÏú† Î≤ÑÌäº</b> ‚Üí<br>
        <b>‚ÄúÌôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä‚Äù</b>Î•º ÎàåÎü¨Ï£ºÏÑ∏Ïöî üêÑ
      </p>
      <button id="closeIosGuide">Îã´Í∏∞</button>
    </div>
  </div>

  <div id="body-rapper">
    <!-- List -->
    <div id="listView"></div>

    <!-- Editor -->
    <div id="editorView">
      <button id="closeEditor">Îã´Í∏∞</button>
      <input id="editorSubject" placeholder="üêÑ Ï†úÎ™© üêÑ">

      <!-- Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº + ÏÇ≠Ï†ú Î≤ÑÌäº -->
      <div id="editorButtons">
        <button class="editor-btn" id="uploadImageBtn">Ïù¥ÎØ∏ÏßÄ üêÑ</button>
        <button class="editor-btn" id="urlImageBtn">URL Ïù¥ÎØ∏ÏßÄ üêÑ</button>
        <button class="editor-btn" id="deleteMemoBtn">Î©îÎ™® ÏÇ≠Ï†ú</button>
      </div>

      <div id="editorText" contenteditable="true" placeholder="üêÑ Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïù¥ÎØ∏ÏßÄ Í∞ÄÎä•) üêÑ"></div>
      <input type="file" id="imageInput" style="display:none" accept="image/*">
    </div>
  </div>

  <button id="addBtn">+</button>

  <!-- Saving -->
  <div id="savingOverlay">Saving... </div>

  <script>
    async function hashSHA256(message) {
      const encoder = new TextEncoder();
      const data = encoder.encode(message);

      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");

      return hashHex;
    }
  </script>
  <script>
    const navbar = document.getElementById("navbar");

    window.addEventListener("scroll", () => {
      if (window.scrollY > 8) {
        navbar.classList.add("scrolled");
      } else {
        navbar.classList.remove("scrolled");
      }
    });
  </script>
  <script>
    const sndMoo    = new Audio("mooooo.wav");
    sndMoo.preload  = "auto";

    /* =========================
        ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù
    ========================= */
    let audioUnlocked = false;

    function playSound(audio) {
        if (!audioUnlocked) return;

        audio.pause();
        audio.currentTime = 0;
        audio.play().catch(() => {});
    }

    document.addEventListener("pointerdown", () => {
        if (audioUnlocked) return;

        audioUnlocked = true;

        const silent = new Audio();
        silent.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";
        silent.play().catch(() => {});
    }, { once: true });
  </script>
  <script>
    let autoSaveTimer = null;

    const listView = document.getElementById("listView");
    const editorView = document.getElementById("editorView");
    const editorSubject = document.getElementById("editorSubject");
    const editorText = document.getElementById("editorText");
    const imageInput = document.getElementById("imageInput");

    /* =========================
        Render Masonry
    ========================= */
    function renderList() {
      listView.innerHTML = "";
      state.memos.forEach((memo, i) => {
        const div = document.createElement("div");
        div.className = "memo-card";
        div.innerHTML = `
          <div class="memo-subject">üêÑ ${memo.subject}</div>
          <div class="memo-text">${memo.text}</div>
        `;
        div.onclick = () => openEditor(i);
        listView.appendChild(div);
      });
    }

    /* =========================
        Editor Ïó¥Í∏∞
    ========================= */
    function openEditor(index) {
      playSound(sndMoo);
      state.activeMemoIndex = index;
      const memo = state.memos[index];
      editorSubject.value = memo.subject;
      editorText.innerHTML = memo.text;
      editorView.style.display = "block";
    }

    /* =========================
        ÏÉà Î©îÎ™® ÏÉùÏÑ±
    ========================= */
    document.getElementById("addBtn").onclick = async () => {
      const m_date = new Date().toISOString();
      const m_hash = await hashSHA256(m_date);

      state.memos.unshift({
        subject: "",
        date: m_date,
        text: "",
        classification_code: m_hash,
        del: 0
      });
      openEditor(0);
    };

    /* =========================
        ÏóêÎîîÌÑ∞ Îã´Í∏∞ & Ï†ÄÏû•
    ========================= */
    document.getElementById("closeEditor").onclick = () => {
      saveAndClose();
    };

    /* =========================
        Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú (Base64)
    ========================= */
    document.getElementById("uploadImageBtn").onclick = () => imageInput.click();
    imageInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (evt) {
          const img = document.createElement("img");
          img.src = evt.target.result; // Base64
          editorText.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    };

    /* =========================
        URLÎ°ú Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
    ========================= */
    document.getElementById("urlImageBtn").onclick = () => {
      const url = prompt("üêÑ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
      if (url) {
        const img = document.createElement("img");
        img.src = url;
        editorText.appendChild(img);
      }
    };

    /* =========================
        Î©îÎ™® ÏÇ≠Ï†ú
    ========================= */
    document.getElementById("deleteMemoBtn").onclick = async () => {
      if (state.activeMemoIndex === null) return;

      if (!confirm("üêÑMeMoooooüêÑoooooüêÑooooo?!!?!?!!")) return;

      const memo = state.memos[state.activeMemoIndex];

      // ÏÇ≠Ï†ú ÌîåÎûòÍ∑∏
      memo.del = 1;

      try {
        await fetch(`${API_BASE}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: state.userId,
            Memooooo: [memo]   // Î©îÎ™® 1Í±¥Îßå Ï†ÑÏÜ°
          })
        });

        // autoSave Ï¥àÍ∏∞Ìôî
        if (autoSaveTimer) {
          clearTimeout(autoSaveTimer);
          autoSaveTimer = null;
        }
      } catch (err) {
        alert("ÏÇ≠Ï†ú Ïã§Ìå® üêÑ\n" + err.message);
        return;
      }

      // Î°úÏª¨ ÏÉÅÌÉú Ï†ïÎ¶¨
      state.memos.splice(state.activeMemoIndex, 1);
      state.activeMemoIndex = null;
      editorView.style.display = "none";
      renderList();
    };

    /* Ï¥àÍ∏∞ Î†åÎçîÎßÅ */
    renderList();
  </script>

  <script>
    /* =========================
      State
    ========================= */
    const state = {
      userId: null,
      memos: [],
      activeMemoIndex: null,
    };

    const API_BASE = "https://memooooo-sheet-api.vercel.app/api";

    /* =========================
      Login
    ========================= */
    function handleLogin(res) {
      const payload = JSON.parse(atob(res.credential.split(".")[1]));
      state.userId = payload.email;

      document.getElementById("loginView").style.display = "none";
      listView.style.display = "block";

      loadMemos();
    }

    /* =========================
      Load
    ========================= */
    async function loadMemos() {
      try {
        const res = await fetch(`${API_BASE}/load?userId=${encodeURIComponent(state.userId)}`,
          {
            method: "GET",
            mode: "cors",
            credentials: "omit"
          }
        );
        const data = await res.json();
        state.memos = data.Memooooo || [];
        renderList();
      } catch (err) {
        console.error("Î°úÎìú Ïã§Ìå®:", err);
        alert("Î©îÎ™®Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
      }
    }

    /* =========================
      Save
    ========================= */
    async function saveAndClose() {
      if (state.activeMemoIndex === null) return;

      const memo = state.memos[state.activeMemoIndex];

      // ÌòÑÏû¨ ÏóêÎîîÌÑ∞ ÎÇ¥Ïö© Î∞òÏòÅ
      memo.subject = editorSubject.value;
      memo.text = editorText.innerHTML;
      memo.del = 0;

      editorView.style.display = "none";
      renderList();

      const overlay = document.getElementById("savingOverlay");
      overlay.style.display = "flex";

      try {
        const res = await fetch(`${API_BASE}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: state.userId,
            Memooooo: [memo]
          })
        });

        if (!res.ok) {
          throw new Error(await res.text());
        }
      } catch (err) {
        alert("Ï†ÄÏû• Ïã§Ìå®\n" + err.message);
        return;
      } finally {
        playSound(sndMoo);
        overlay.style.display = "none";
      }
    }

    /* =========================
      Auto Save
    ========================= */
    async function autoSaveSilently() {
      if (state.activeMemoIndex === null) return;
      if (editorView.style.display !== "block") return;

      const memo = state.memos[state.activeMemoIndex];

      memo.subject = editorSubject.value;
      memo.text = editorText.innerHTML;
      memo.del = 0;

      try {
        const res = await fetch(`${API_BASE}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: state.userId,
            Memooooo: [memo]
          })
        });

        if (!res.ok) {
          throw new Error(await res.text());
        }
        console.log("üêÑ auto-saved");
      } catch (err) {
        console.error("ÏûêÎèô Ï†ÄÏû• Ïã§Ìå®:", err);
      }
    }


    // ÏûÖÎ†• Í∞êÏßÄ
    function scheduleAutoSave() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);

      autoSaveTimer = setTimeout(() => {
        autoSaveSilently();
      }, 10000); // 10Ï¥àÍ∞Ñ ÏûÖÎ†• ÏóÜÏúºÎ©¥
    }

    // Ï†úÎ™© ÏûÖÎ†•
    editorSubject.addEventListener("input", scheduleAutoSave);

    // Î≥∏Î¨∏ ÏûÖÎ†• (contenteditable)
    editorText.addEventListener("input", scheduleAutoSave);



    /* Ctrl / Cmd + S Ï†ÄÏû• */
    window.addEventListener("keydown", e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();
        saveAndClose();
      }
    });
  </script>

  <script>
    let deferredPrompt = null;

    /* =========================
      PWA Install Detect
    ========================= */
    window.addEventListener("beforeinstallprompt", e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "block";
    });

    if (isStandalone()) {
      document.getElementById("installBtn").style.display = "none";
    } else {
      document.getElementById("installBtn").style.display = "block";
    }

    /* =========================
      Install Button Click
    ========================= */
    document.getElementById("installBtn").onclick = async () => {
      // ÏÑ§Ïπò Í∞ÄÎä•Ìïú Î∏åÎùºÏö∞Ï†Ä
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        return;
      }

      // iOS Safari
      if (isIOS()) {
        document.getElementById("iosInstallGuide").style.display = "flex";
        return;
      }

      alert("Ïù¥ ÌôòÍ≤ΩÏóêÏÑúÎäî ÏÑ§ÏπòÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§ üêÑ");
    };

    /* =========================
      iOS Detect
    ========================= */
    function isIOS() {
      return /iphone|ipad|ipod/i.test(navigator.userAgent);
    }

    document.getElementById("closeIosGuide").onclick = () => {
      document.getElementById("iosInstallGuide").style.display = "none";
    };

  </script>
</body>

</html>
