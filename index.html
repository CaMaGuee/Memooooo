<!DOCTYPE html>
<html lang="ko">

<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <link rel="icon" type="image/png" href="favicon.png?v=2">
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <link rel="apple-touch-icon" href="favicon.png?v=2">
  <link rel="shortcut icon" href="favicon.ico?v=2">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêÑMemoooooüêÑ</title>
  <style>
      body {
        margin: 0;
        font-family: "Noto Sans KR", sans-serif;
        background: linear-gradient(135deg, #f0f2f5, #e0e6f0);
      }
  
      /* ===== Masonry ===== */
      #listView {
        display: block;
        padding: 20px;
        column-count: 4;
        column-gap: 20px;
      }
  
      @media (max-width: 1200px) { #listView { column-count: 3; } }
      @media (max-width: 800px) { #listView { column-count: 2; } }
      @media (max-width: 500px) { #listView { column-count: 1; } }
  
      .memo-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 20px;
        break-inside: avoid;
        cursor: pointer;
        box-shadow: 0 8px 16px rgba(0, 0, 0, .12);
        transition: transform 0.2s, box-shadow 0.2s;
      }
  
      .memo-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, .15);
      }
  
      .memo-subject {
        font-weight: 600;
        font-size: 17px;
        color: #333333;
        margin-bottom: 10px;
      }
  
      .memo-text {
        font-size: 15px;
        color: #777777;
        white-space: pre-wrap;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 5; /* 5Ï§Ñ Ï†úÌïú */
        -webkit-box-orient: vertical;
        margin: 0 10px 0 10px;
      }
  
      /* ===== Floating Button ===== */
      #addBtn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 26px;
        border: none;
        background: #317EFB80;
        color: white;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 0, 0, .2);
        transition: transform 0.2s, box-shadow 0.2s;
      }
  
      #addBtn:hover {
        transform: scale(1.1) rotate(45deg);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #317EFB;
      }
  
      /* ===== Editor ===== */
      #editorView {
        display: none;
        position: fixed;
        inset: 0;
        background: white;
        z-index: 100;
        padding: 16px;
      }
  
      #editorSubject {
        width: 99%;
        font-size: 20px;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
  
      #editorButtons {
        margin-bottom: 12px;
      }
  
      .editor-btn {
        margin-right: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        color: white;
      }
  
      #uploadImageBtn { background: #4CAF5090; }
      #urlImageBtn { background: #2196F390; }
      #deleteMemoBtn { 
        position: fixed;
        bottom: 12px;
        left: 12px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: #555;
        color: white;
        cursor: pointer;
        background: #f4433690;
      }
  
      #uploadImageBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #4CAF50;
      }
      #urlImageBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #2196F3;
      }
      #deleteMemoBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #f44336;
      }
  
      #editorText {
        width: 99%;
        height: calc(100vh - 220px);
        font-size: 15px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        overflow-y: auto;
      }
  
      #editorText:focus {
        outline: 2px solid #317EFB;
      }
  
      #closeEditor {
        position: fixed;
        bottom: 12px;
        right: 12px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: #555;
        color: white;
        cursor: pointer;
      }
  
      /* Ïπ¥Îìú Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï†úÌïú */
      .memo-text img, #editorText img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }
    </style>
  </head>
  
  <body>
  
  <!-- Login -->
  <div id="loginView">
    <div id="g_id_onload"
      data-client_id="765077747854-o62lf714ob2ncr2sq0l68ies31hp6p43.apps.googleusercontent.com"
      data-callback="handleLogin"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin"></div>
  </div>
  
  <!-- List -->
  <div id="listView"></div>
  <button id="addBtn">+</button>

  <!-- Editor -->
  <div id="editorView">
    <button id="closeEditor">Îã´Í∏∞</button>
    <input id="editorSubject" placeholder="üêÑ Ï†úÎ™© üêÑ">

    <!-- Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº + ÏÇ≠Ï†ú Î≤ÑÌäº -->
    <div id="editorButtons">
      <button class="editor-btn" id="uploadImageBtn">Ïù¥ÎØ∏ÏßÄ üêÑ</button>
      <button class="editor-btn" id="urlImageBtn">URL Ïù¥ÎØ∏ÏßÄ üêÑ</button>
      <button class="editor-btn" id="deleteMemoBtn">Î©îÎ™® ÏÇ≠Ï†ú</button>
    </div>

    <div id="editorText" contenteditable="true" placeholder="üêÑ Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïù¥ÎØ∏ÏßÄ Í∞ÄÎä•) üêÑ"></div>
    <input type="file" id="imageInput" style="display:none" accept="image/*">
  </div>
  
  <!-- Saving -->
  <div id="savingOverlay">üêÑ Saving... üêÑ</div>

  <script>
    const listView = document.getElementById("listView");
    const editorView = document.getElementById("editorView");
    const editorSubject = document.getElementById("editorSubject");
    const editorText = document.getElementById("editorText");
    const imageInput = document.getElementById("imageInput");

    /* =========================
        Render Masonry
    ========================= */
    function renderList() {
      listView.innerHTML = "";
      state.memos.forEach((memo, i) => {
        const div = document.createElement("div");
        div.className = "memo-card";
        div.innerHTML = `
          <div class="memo-subject">üêÑ ${memo.subject}</div>
          <div class="memo-text">${memo.text}</div>
        `;
        div.onclick = () => openEditor(i);
        listView.appendChild(div);
      });
    }

    /* =========================
        Editor Ïó¥Í∏∞
    ========================= */
    function openEditor(index) {
      state.activeMemoIndex = index;
      const memo = state.memos[index];
      editorSubject.value = memo.subject;
      editorText.innerHTML = memo.text;
      editorView.style.display = "block";
    }

    /* =========================
        ÏÉà Î©îÎ™® ÏÉùÏÑ±
    ========================= */
    document.getElementById("addBtn").onclick = () => {
      state.memos.unshift({
        subject: "",
        date: new Date().toISOString(),
        text: ""
      });
      openEditor(0);
    };

    /* =========================
        ÏóêÎîîÌÑ∞ Îã´Í∏∞ & Ï†ÄÏû•
    ========================= */
    document.getElementById("closeEditor").onclick = () => {
      saveAndClose();
    };

    /* =========================
        Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú (Base64)
    ========================= */
    document.getElementById("uploadImageBtn").onclick = () => imageInput.click();
    imageInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          const img = document.createElement("img");
          img.src = evt.target.result; // Base64
          editorText.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    };

    /* =========================
        URLÎ°ú Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
    ========================= */
    document.getElementById("urlImageBtn").onclick = () => {
      const url = prompt("üêÑ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
      if (url) {
        const img = document.createElement("img");
        img.src = url;
        editorText.appendChild(img);
      }
    };

    /* =========================
        Î©îÎ™® ÏÇ≠Ï†ú
    ========================= */
    document.getElementById("deleteMemoBtn").onclick = () => {
      if (state.activeMemoIndex !== null) {
        if (confirm("üêÑ Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî? üêÑ")) {
          state.memos.splice(state.activeMemoIndex, 1);
          state.activeMemoIndex = null;
          editorView.style.display = "none";
          renderList();
          saveAndClose(); // ‚úÖ ÏÇ≠Ï†ú ÌõÑ ÏÑúÎ≤Ñ Î∞òÏòÅ
        }
      }
    };

    /* Ï¥àÍ∏∞ Î†åÎçîÎßÅ */
    renderList();
  </script>
  
  <script>
  /* =========================
     State
  ========================= */
  const state = {
    userId: null,
    memos: [],
    activeMemoIndex: null,
  };
  
  const API_BASE = "https://memooooo-sheet-api.vercel.app/api";
  
  /* =========================
     Login
  ========================= */
  function handleLogin(res) {
    const payload = JSON.parse(atob(res.credential.split(".")[1]));
    state.userId = payload.email;
  
    document.getElementById("loginView").style.display = "none";
    listView.style.display = "block";
  
    loadMemos();
  }
  
  /* =========================
     Load
  ========================= */
  async function loadMemos() {
    try {
      const res = await fetch(`${API_BASE}/load?userId=${encodeURIComponent(state.userId)}`,
        {
          method: "GET",
          mode: "cors",
          credentials: "omit"
        }
      );
      const data = await res.json();
      state.memos = data.Memooooo || [];
      renderList();
    } catch (err) {
      console.error("Î°úÎìú Ïã§Ìå®:", err);
      alert("Î©îÎ™®Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
    }
  }
  
  /* =========================
     Save
  ========================= */
  async function saveAndClose() {
    if (state.activeMemoIndex !== null) {
      const memo = state.memos[state.activeMemoIndex];
      memo.subject = editorSubject.value;
      memo.text = editorText.innerHTML;
    }

    editorView.style.display = "none";
    renderList();

    const overlay = document.getElementById("savingOverlay");
    overlay.style.display = "flex";

    try {
      const res = await fetch(`${API_BASE}/save`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: state.userId,
          Memooooo: state.memos
        })
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("Ï†ÄÏû• Ïã§Ìå®:", text);
        alert("Ï†ÄÏû• Ïã§Ìå®: " + text);
      }
    } catch (err) {
      console.error("Ï†ÄÏû• Ï§ë ÏóêÎü¨:", err);
      alert("Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù");
    } finally {
      overlay.style.display = "none";
    }
  }
  
  /* Ctrl / Cmd + S Ï†ÄÏû• */
  window.addEventListener("keydown", e => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
      e.preventDefault();
      saveAndClose();
    }
  });
  </script>
  
  </body>
  </html>
  
