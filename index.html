<!DOCTYPE html>
<html lang="ko">

<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <link rel="icon" type="image/png" href="favicon.png?v=2">
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <link rel="apple-touch-icon" href="favicon.png?v=2">
  <link rel="shortcut icon" href="favicon.ico?v=2">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ„MemoooooğŸ„</title>
  <style>
      body {
        margin: 0;
        font-family: "Noto Sans KR", sans-serif;
        background: linear-gradient(135deg, #f0f2f5, #e0e6f0);
      }

      #loginView {
        display: flex;
        justify-content: center;
        align-items: center;
        width:100%;
        height: 100vh;
        background-color: #ccc;
        z-index: 99999;
        position: relative;
      }

      /* ===== Navigation Bar ===== */
      #navbar {
        position: sticky;
        top: 0;
        z-index: 9999;
        height: 56px;
        background: #ffffffcc;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
      }

      #navTitle {
        font-size: 18px;
        font-weight: 700;
      }

      #installBtn {
        border: none;
        border-radius: 20px;
        padding: 6px 14px;
        background: #317EFB;
        color: white;
        cursor: pointer;
        font-size: 14px;
      }

      #installBtn:hover {
        background: #255fd6;
      }

      /* ===== iOS Install Guide ===== */
      #iosInstallGuide {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.5);
        z-index: 999;
        justify-content: center;
        align-items: flex-end;
      }

      .ios-box {
        width: 100%;
        background: white;
        border-radius: 16px 16px 0 0;
        padding: 20px;
        text-align: center;
      }

      .ios-box p {
        font-size: 14px;
        margin: 12px 0;
      }

      #closeIosGuide {
        border: none;
        background: #ddd;
        padding: 6px 14px;
        border-radius: 8px;
      }
  
      /* ===== Masonry ===== */
      #listView {
        display: block;
        padding: 20px;
        column-count: 4;
        column-gap: 10px;     /* â† ê¸°ì¡´ 20px â†’ 10px ë˜ëŠ” 8pxë¡œ ì¤„ì´ê¸° (ê¸°ë³¸ê°’ì´ í¬ë©´ ë§ˆì§„ì²˜ëŸ¼ ë³´ì„) */
      }

      @media (max-width: 1200px) { #listView { column-count: 3; column-gap: 12px; } }
      @media (max-width: 800px)  { #listView { column-count: 2; column-gap: 10px; } }
  
      .memo-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;   /* â† 20px â†’ 12px ë˜ëŠ” 10pxë¡œ ì¤„ì´ê¸° */
        margin-left: 0;        /* ì¢Œìš° ì—¬ë°± ì œê±° (í•„ìš” ì‹œ) */
        margin-right: 0;
        break-inside: avoid;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);  /* hover ì—†ì´ë„ ì‚´ì§ ê·¸ë¦¼ì */
      }
  
      .memo-card:hover {
        transform: translateY(-4px);
      }
  
      .memo-subject {
        width:99%;
        font-weight: 600;
        font-size: 17px;
        color: #333333;
        margin-bottom: 10px;
      }
  
      .memo-text {
        width:99%;
        font-size: 15px;
        color: #777777;
        white-space: pre-wrap;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 5; /* 5ì¤„ ì œí•œ */
        -webkit-box-orient: vertical;
        margin: 0 10px 0 10px;
      }
  
      /* ===== Floating Button ===== */
      #addBtn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 26px;
        border: none;
        background: #317EFB80;
        color: white;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 0, 0, .2);
        transition: transform 0.2s, box-shadow 0.2s;
      }
  
      #addBtn:hover {
        transform: scale(1.1) rotate(45deg);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #317EFB;
      }
  
      /* ===== Editor ===== */
      #editorView {
        display: none;
        position: fixed;
        inset: 0;
        background: white;
        z-index: 100;
        padding: 16px;
        margin-top: 60px;
      }
  
      #editorSubject {
        width: 99%;
        font-size: 20px;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
  
      #editorButtons {
        margin-bottom: 12px;
      }
  
      .editor-btn {
        margin-right: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        color: white;
      }
  
      #uploadImageBtn { background: #4CAF5090; }
      #urlImageBtn { background: #2196F390; }
      #deleteMemoBtn { 
        position: fixed;
        bottom: 12px;
        left: 12px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: #555;
        color: white;
        cursor: pointer;
        background: #f4433690;
      }
  
      #uploadImageBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #4CAF50;
      }
      #urlImageBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #2196F3;
      }
      #deleteMemoBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, .25);
        background: #f44336;
      }
  
      #editorText {
        width: 99%;
        height: calc(100vh - 300px);
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        overflow-y: auto;
        touch-action: manipulation;   /* í„°ì¹˜ ì§€ì—°/ì¤Œ ë°©ì§€ */
        -webkit-text-size-adjust: 100%;  /* iOS í…ìŠ¤íŠ¸ í¬ê¸° ìë™ ì¡°ì • ë§‰ê¸° */
        font-size: 15px !important;
      }
  
      #editorText:focus {
        outline: 2px solid #317EFB;
      }
  
      #closeEditor {
        position: fixed;
        bottom: 12px;
        right: 12px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: #555;
        color: white;
        cursor: pointer;
      }
  
      /* ì¹´ë“œ ì´ë¯¸ì§€ í¬ê¸° ì œí•œ */
      .memo-text img, #editorText img {
        max-width: 80%;
        height: auto;
        border-radius: 8px;
      }

      /* ===== Saving Overlay ===== */
      #savingOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
        color: white;
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 1px;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
      }

      #savingOverlay::after {
        content: "ğŸ„";
        margin-left: 8px;
        animation: moo 0.3s infinite alternate;
      }

      @keyframes moo {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-6px);
        }
      }

      /* ê¸°ì¡´ media query ì‚­ì œ ë˜ëŠ” ì£¼ì„ */
      @media (max-width: 480px) {
        #body-rapper {
          transform: none !important;  
        }
        
        #editorView {
          padding-bottom: 500px;       /* í‚¤ë³´ë“œ ì˜¬ë¼ì˜¬ ë•Œ ì—¬ìœ  ê³µê°„ í™•ë³´ */
          box-sizing: border-box;
        }
        
        #editorText {
          min-height: 40vh;            /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ */
        }
      }

      /* ì¶”ê°€: focus ì‹œ ì‹œê°ì  í”¼ë“œë°± */
      #editorText:focus {
        outline: 2px solid #317EFB;
        box-shadow: 0 0 0 4px rgba(49, 126, 251, 0.2);
      }

      /* í¬ì»¤ìŠ¤ ì‹œ í™•ëŒ€ ë°©ì§€ (iOSìš©) */
      @media screen and (max-device-width: 1024px) {
        #editorText:focus {
          font-size: 16px;
        }
      }
    </style>
  </head>
  
  <body>
    <div id="navbar">
        <div id="navTitle">ğŸ„ Memooooooooooooooo</div>
        <button id="installBtn">ì„¤ì¹˜</button>
    </div>

    <!-- Login -->
    <div id="loginView">
      <div id="g_id_onload"
        data-client_id="765077747854-o62lf714ob2ncr2sq0l68ies31hp6p43.apps.googleusercontent.com"
        data-callback="handleLogin"
        data-auto_prompt="false">
      </div>
      <div class="g_id_signin"></div>
    </div>

    <!-- iOS Install Guide -->
    <div id="iosInstallGuide">
      <div class="ios-box">
        <strong>ğŸ“² í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</strong>
        <p>
          Safari í•˜ë‹¨ì˜ <b>ê³µìœ  ë²„íŠ¼</b> â†’<br>
          <b>â€œí™ˆ í™”ë©´ì— ì¶”ê°€â€</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš” ğŸ„
        </p>
        <button id="closeIosGuide">ë‹«ê¸°</button>
      </div>
    </div>
    
    <div id="body-rapper">
      <!-- List -->
      <div id="listView"></div>

      <!-- Editor -->
      <div id="editorView">
        <button id="closeEditor">ë‹«ê¸°</button>
        <input id="editorSubject" placeholder="ğŸ„ ì œëª© ğŸ„">

        <!-- ì´ë¯¸ì§€ ë²„íŠ¼ + ì‚­ì œ ë²„íŠ¼ -->
        <div id="editorButtons">
          <button class="editor-btn" id="uploadImageBtn">ì´ë¯¸ì§€ ğŸ„</button>
          <button class="editor-btn" id="urlImageBtn">URL ì´ë¯¸ì§€ ğŸ„</button>
          <button class="editor-btn" id="deleteMemoBtn">ë©”ëª¨ ì‚­ì œ</button>
        </div>

        <div id="editorText" contenteditable="true" placeholder="ğŸ„ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì´ë¯¸ì§€ ê°€ëŠ¥) ğŸ„"></div>
        <input type="file" id="imageInput" style="display:none" accept="image/*">
      </div>
    </div>

    <button id="addBtn">+</button>
    
    <!-- Saving -->
    <div id="savingOverlay">Saving... </div>

    <script>
      async function hashSHA256(message) {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);

        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");

        return hashHex;
      }
    </script>
    <script>
      let autoSaveTimer = null;

      const listView = document.getElementById("listView");
      const editorView = document.getElementById("editorView");
      const editorSubject = document.getElementById("editorSubject");
      const editorText = document.getElementById("editorText");
      const imageInput = document.getElementById("imageInput");

      /* =========================
          Render Masonry
      ========================= */
      function renderList() {
        listView.innerHTML = "";
        state.memos.forEach((memo, i) => {
          const div = document.createElement("div");
          div.className = "memo-card";
          div.innerHTML = `
            <div class="memo-subject">ğŸ„ ${memo.subject}</div>
            <div class="memo-text">${memo.text}</div>
          `;
          div.onclick = () => openEditor(i);
          listView.appendChild(div);
        });
      }

      /* =========================
          Editor ì—´ê¸°
      ========================= */
      function openEditor(index) {
        state.activeMemoIndex = index;
        const memo = state.memos[index];
        editorSubject.value = memo.subject;
        editorText.innerHTML = memo.text;
        editorView.style.display = "block";
      }

      /* =========================
          ìƒˆ ë©”ëª¨ ìƒì„±
      ========================= */
      document.getElementById("addBtn").onclick = async () => {
        const m_date = new Date().toISOString();
        const m_hash = await hashSHA256(m_date);

        state.memos.unshift({
          subject: "",
          date: m_date,
          text: "",
          classification_code: m_hash,
          del: 0
        });
        openEditor(0);
      };

      /* =========================
          ì—ë””í„° ë‹«ê¸° & ì €ì¥
      ========================= */
      document.getElementById("closeEditor").onclick = () => {
        saveAndClose();
      };

      /* =========================
          ì´ë¯¸ì§€ ì—…ë¡œë“œ (Base64)
      ========================= */
      document.getElementById("uploadImageBtn").onclick = () => imageInput.click();
      imageInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            const img = document.createElement("img");
            img.src = evt.target.result; // Base64
            editorText.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      };

      /* =========================
          URLë¡œ ì´ë¯¸ì§€ ì¶”ê°€
      ========================= */
      document.getElementById("urlImageBtn").onclick = () => {
        const url = prompt("ğŸ„ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (url) {
          const img = document.createElement("img");
          img.src = url;
          editorText.appendChild(img);
        }
      };

      /* =========================
          ë©”ëª¨ ì‚­ì œ
      ========================= */
      document.getElementById("deleteMemoBtn").onclick = async () => {
        if (state.activeMemoIndex === null) return;

        if (!confirm("ğŸ„MeMoooooğŸ„oooooğŸ„ooooo?!!?!?!!")) return;

        const memo = state.memos[state.activeMemoIndex];

        // ì‚­ì œ í”Œë˜ê·¸
        memo.del = 1;

        try {
          await fetch(`${API_BASE}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: state.userId,
              Memooooo: [memo]   // ë©”ëª¨ 1ê±´ë§Œ ì „ì†¡
            })
          });

          // autoSave ì´ˆê¸°í™”
          if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = null;
          }
        } catch (err) {
          alert("ì‚­ì œ ì‹¤íŒ¨ ğŸ„\n" + err.message);
          return;
        }

        // ë¡œì»¬ ìƒíƒœ ì •ë¦¬
        state.memos.splice(state.activeMemoIndex, 1);
        state.activeMemoIndex = null;
        editorView.style.display = "none";
        renderList();
      };

      /* ì´ˆê¸° ë Œë”ë§ */
      renderList();
    </script>
    
    <script>
    /* =========================
      State
    ========================= */
    const state = {
      userId: null,
      memos: [],
      activeMemoIndex: null,
    };
    
    const API_BASE = "https://memooooo-sheet-api.vercel.app/api";
    
    let savingInProgress = false;

    /* =========================
      Login
    ========================= */
    function handleLogin(res) {
      const payload = JSON.parse(atob(res.credential.split(".")[1]));
      state.userId = payload.email;
    
      document.getElementById("loginView").style.display = "none";
      listView.style.display = "block";
    
      loadMemos();
    }
    
    /* =========================
      Load
    ========================= */
    async function loadMemos() {
      try {
        const res = await fetch(`${API_BASE}/load?userId=${encodeURIComponent(state.userId)}`,
          {
            method: "GET",
            mode: "cors",
            credentials: "omit"
          }
        );
        const data = await res.json();
        state.memos = data.Memooooo || [];
        renderList();
      } catch (err) {
        console.error("ë¡œë“œ ì‹¤íŒ¨:", err);
        alert("ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }
    
    /* =========================
      Save
    ========================= */
    async function saveAndClose() {
      if (state.activeMemoIndex === null) return;

      const memo = state.memos[state.activeMemoIndex];

      // í˜„ì¬ ì—ë””í„° ë‚´ìš© ë°˜ì˜
      memo.subject = editorSubject.value;
      memo.text = editorText.innerHTML;
      memo.del = 0;

      editorView.style.display = "none";
      renderList();

      const overlay = document.getElementById("savingOverlay");
      overlay.style.display = "flex";

      try {
        const res = await fetch(`${API_BASE}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: state.userId,
            Memooooo: [memo]
          })
        });

        if (!res.ok) {
          throw new Error(await res.text());
        }
      } catch (err) {
        alert("ì €ì¥ ì‹¤íŒ¨\n" + err.message);
      } finally {
        overlay.style.display = "none";
      }
    }

    /* =========================
      Auto Save
    ========================= */
    async function autoSaveSilently() {
      if (state.activeMemoIndex === null) return;
      if (editorView.style.display !== "block") return;

      const memo = state.memos[state.activeMemoIndex];

      memo.subject = editorSubject.value;
      memo.text = editorText.innerHTML;
      memo.del = 0;

      try {
        const res = await fetch(`${API_BASE}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: state.userId,
            Memooooo: [memo]
          })
        });

        if (!res.ok) {
          throw new Error(await res.text());
        }
        console.log("ğŸ„ auto-saved");
      } catch (err) {
        console.error("ìë™ ì €ì¥ ì‹¤íŒ¨:", err);
      }
    }


    // ì…ë ¥ ê°ì§€
    function scheduleAutoSave() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);

      autoSaveTimer = setTimeout(() => {
        autoSaveSilently();
      }, 10000); // 10ì´ˆê°„ ì…ë ¥ ì—†ìœ¼ë©´
    }

    // ì œëª© ì…ë ¥
    editorSubject.addEventListener("input", scheduleAutoSave);

    // ë³¸ë¬¸ ì…ë ¥ (contenteditable)
    editorText.addEventListener("input", scheduleAutoSave);


    
    /* Ctrl / Cmd + S ì €ì¥ */
    window.addEventListener("keydown", e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();
        saveAndClose();
      }
    });
    </script>

    <script>
    let deferredPrompt = null;

    /* =========================
      PWA Install Detect
    ========================= */
    window.addEventListener("beforeinstallprompt", e => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "block";
    });

    if(isStandalone()){
        document.getElementById("installBtn").style.display = "none";
    } else {
        document.getElementById("installBtn").style.display = "block";
    }

    /* =========================
      Install Button Click
    ========================= */
    document.getElementById("installBtn").onclick = async () => {
      // ì„¤ì¹˜ ê°€ëŠ¥í•œ ë¸Œë¼ìš°ì €
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        return;
      }

      // iOS Safari
      if (isIOS()) {
        document.getElementById("iosInstallGuide").style.display = "flex";
        return;
      }

      alert("ì´ í™˜ê²½ì—ì„œëŠ” ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ ğŸ„");
    };

    /* =========================
      iOS Detect
    ========================= */
    function isIOS() {
      return /iphone|ipad|ipod/i.test(navigator.userAgent);
    }

    document.getElementById("closeIosGuide").onclick = () => {
      document.getElementById("iosInstallGuide").style.display = "none";
    };

    </script>
  </body>
</html>
  
